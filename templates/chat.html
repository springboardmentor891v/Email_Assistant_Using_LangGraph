{% extends "base.html" %}

{% block title %}Chat Assistant{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: calc(100vh - 250px);
        display: flex;
        flex-direction: column;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        scroll-behavior: smooth;
    }

    .message {
        margin-bottom: 1rem;
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .user-message {
        display: flex;
        justify-content: flex-end;
    }

    .assistant-message {
        display: flex;
        justify-content: flex-start;
    }

    .message-bubble {
        max-width: 70%;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        word-wrap: break-word;
    }

    .user-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 0.25rem;
    }

    .assistant-bubble {
        background: #f3f4f6;
        color: #1f2937;
        border-bottom-left-radius: 0.25rem;
    }

    .typing-indicator {
        display: none;
        align-items: center;
        gap: 0.25rem;
    }

    .typing-indicator.active {
        display: flex;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        background: #9ca3af;
        border-radius: 50%;
        animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {

        0%,
        60%,
        100% {
            transform: translateY(0);
        }

        30% {
            transform: translateY(-10px);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900">
            <i class="fas fa-comments text-purple-600 mr-2"></i>
            Chat Assistant
        </h1>
        <p class="text-gray-600 mt-2">Ask me anything about your emails, calendar, or let me help you draft responses.
        </p>
    </div>

    <!-- Chat Container -->
    <div class="bg-white rounded-xl shadow-lg chat-container">
        <!-- Chat Messages -->
        <div id="chatMessages" class="chat-messages bg-gray-50">
            <!-- Welcome Message -->
            <div class="message assistant-message">
                <div class="message-bubble assistant-bubble">
                    <div class="flex items-start space-x-3">
                        <div class="p-2 bg-purple-100 rounded-full">
                            <i class="fas fa-robot text-purple-600"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900 mb-1">AI Assistant</p>
                            <p class="text-gray-700">
                                Hello! I'm your email assistant. I can help you:
                            </p>
                            <ul class="mt-2 space-y-1 text-sm text-gray-600">
                                <li>• Summarize your unread emails</li>
                                <li>• Draft replies to messages</li>
                                <li>• Check your calendar and schedule meetings</li>
                                <li>• Search for specific emails</li>
                            </ul>
                            <p class="mt-2 text-sm text-gray-600">What would you like to do?</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Previous Chat History -->
            {% if chat_history %}
            {% for message in chat_history %}
            {% if message.role == 'user' %}
            <div class="message user-message">
                <div class="message-bubble user-bubble">
                    <p>{{ message.message }}</p>
                </div>
            </div>
            {% else %}
            <div class="message assistant-message">
                <div class="message-bubble assistant-bubble">
                    <div class="flex items-start space-x-3">
                        <div class="p-2 bg-purple-100 rounded-full flex-shrink-0">
                            <i class="fas fa-robot text-purple-600"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-gray-700 whitespace-pre-wrap">{{ message.message }}</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
            {% endif %}

            <!-- Typing Indicator -->
            <div id="typingIndicator" class="message assistant-message typing-indicator">
                <div class="message-bubble assistant-bubble">
                    <div class="flex items-center space-x-2">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="border-t border-gray-200 p-4 bg-white rounded-b-xl">
            <form id="chatForm" class="flex items-center space-x-3">
                <input type="text" id="messageInput" placeholder="Type your message..."
                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    autocomplete="off" />
                <button type="submit"
                    class="btn-primary text-white px-6 py-3 rounded-lg font-medium flex items-center space-x-2 shadow-lg">
                    <i class="fas fa-paper-plane"></i>
                    <span>Send</span>
                </button>
                <button type="button" onclick="clearChat()"
                    class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-3 rounded-lg transition">
                    <i class="fas fa-trash"></i>
                </button>
            </form>

            <!-- Quick Action Buttons -->
            <div class="mt-3 flex flex-wrap gap-2">
                <button onclick="sendQuickMessage('Summarize my unread emails')"
                    class="text-sm px-3 py-1.5 bg-purple-100 text-purple-700 rounded-full hover:bg-purple-200 transition">
                    Summarize unread emails
                </button>
                <button onclick="sendQuickMessage('What meetings do I have this week?')"
                    class="text-sm px-3 py-1.5 bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 transition">
                    Check calendar
                </button>
                <button onclick="sendQuickMessage('How many unread emails do I have?')"
                    class="text-sm px-3 py-1.5 bg-green-100 text-green-700 rounded-full hover:bg-green-200 transition">
                    Count unread
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const chatMessages = document.getElementById('chatMessages');
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const typingIndicator = document.getElementById('typingIndicator');

    // Scroll to bottom of chat
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Add user message to chat
    function addUserMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message user-message';
        messageDiv.innerHTML = `
        <div class="message-bubble user-bubble">
            <p>${escapeHtml(message)}</p>
        </div>
    `;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }

    // Add assistant message to chat
    function addAssistantMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message assistant-message';
        messageDiv.innerHTML = `
        <div class="message-bubble assistant-bubble">
            <div class="flex items-start space-x-3">
                <div class="p-2 bg-purple-100 rounded-full flex-shrink-0">
                    <i class="fas fa-robot text-purple-600"></i>
                </div>
                <div class="flex-1">
                    <p class="text-gray-700 whitespace-pre-wrap">${escapeHtml(message)}</p>
                </div>
            </div>
        </div>
    `;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }

    // Escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Show typing indicator
    function showTyping() {
        typingIndicator.classList.add('active');
        scrollToBottom();
    }

    // Hide typing indicator
    function hideTyping() {
        typingIndicator.classList.remove('active');
    }

    // Send message
    async function sendMessage(message) {
        if (!message.trim()) return;

        addUserMessage(message);
        messageInput.value = '';
        showTyping();

        try {
            const response = await fetch('/chat/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();
            hideTyping();

            if (data.success) {
                addAssistantMessage(data.response);
            } else {
                addAssistantMessage('Sorry, I encountered an error. Please try again.');
            }
        } catch (error) {
            hideTyping();
            addAssistantMessage('Sorry, I could not process your request. Please try again.');
        }
    }

    // Form submit handler
    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        sendMessage(message);
    });

    // Quick message handler
    function sendQuickMessage(message) {
        sendMessage(message);
    }

    // Clear chat
    async function clearChat() {
        if (confirm('Clear chat history?')) {
            try {
                await fetch('/chat/clear', { method: 'POST' });
                location.reload();
            } catch (error) {
                alert('Error clearing chat');
            }
        }
    }

    // Auto-focus input
    messageInput.focus();
    scrollToBottom();
</script>
{% endblock %}